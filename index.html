<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Guardian Futures Engine</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --panel2:#0f1730;
      --muted:#8ea0c6;
      --text:#eaf0ff;
      --line:#22325b;
      --good:#2ee59d;
      --warn:#ffcc66;
      --bad:#ff5f73;
      --accent:#6ea8ff;
      --shadow: 0 20px 50px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(110,168,255,.25), transparent 60%),
        radial-gradient(900px 500px at 95% 0%, rgba(46,229,157,.18), transparent 60%),
        radial-gradient(900px 500px at 50% 120%, rgba(255,204,102,.12), transparent 60%),
        var(--bg);
    }
    a{color:var(--accent); text-decoration:none}
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:24px 18px 64px;
    }
    .top{
      display:flex; gap:16px; align-items:flex-start; justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:16px;
    }
    .brand{
      display:flex; flex-direction:column; gap:6px;
    }
    .brand h1{
      margin:0; font-size:22px; letter-spacing:.2px;
    }
    .brand .sub{
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
      max-width:720px;
    }
    .pillrow{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .pill strong{color:var(--text); font-weight:650}
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      align-items:start;
    }
    @media(max-width:980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:rgba(0,0,0,.10);
    }
    .card .hd h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
      color:var(--text);
      font-weight:700;
    }
    .card .bd{padding:14px}
    .muted{color:var(--muted)}
    .row{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 0;
      border-bottom:1px dashed rgba(34,50,91,.75);
    }
    .row:last-child{border-bottom:none}
    .k{color:var(--muted); font-size:12px}
    .v{font-weight:650}
    .btnrow{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:12px;
    }
    button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:700;
      cursor:pointer;
      transition:.12s transform,.12s opacity,.12s background;
      display:inline-flex;
      gap:8px;
      align-items:center;
      user-select:none;
    }
    button:hover{transform:translateY(-1px); background:rgba(255,255,255,.07)}
    button:active{transform:translateY(0px); opacity:.9}
    button.primary{
      border-color:rgba(110,168,255,.55);
      background:rgba(110,168,255,.12);
    }
    button.good{
      border-color:rgba(46,229,157,.55);
      background:rgba(46,229,157,.10);
    }
    button.warn{
      border-color:rgba(255,204,102,.55);
      background:rgba(255,204,102,.10);
    }
    button.bad{
      border-color:rgba(255,95,115,.55);
      background:rgba(255,95,115,.10);
    }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none !important;
    }
    input, select{
      width:100%;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    .small{font-size:12px}
    .mono{font-family:var(--mono)}
    .badge{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;}
    .b-good .dot{background:var(--good)}
    .b-warn .dot{background:var(--warn)}
    .b-bad .dot{background:var(--bad)}
    .b-neutral .dot{background:var(--muted)}
    .b-good{border-color:rgba(46,229,157,.55); background:rgba(46,229,157,.08)}
    .b-warn{border-color:rgba(255,204,102,.55); background:rgba(255,204,102,.08)}
    .b-bad{border-color:rgba(255,95,115,.55); background:rgba(255,95,115,.08)}
    .b-neutral{border-color:rgba(142,160,198,.35); background:rgba(142,160,198,.06)}
    .table{
      display:flex; flex-direction:column; gap:10px;
    }
    .cand{
      border:1px solid var(--line);
      border-radius:var(--radius2);
      padding:12px;
      background:rgba(0,0,0,.10);
      cursor:pointer;
      transition:.12s transform,.12s background;
    }
    .cand:hover{transform:translateY(-1px); background:rgba(255,255,255,.04)}
    .cand.sel{outline:2px solid rgba(110,168,255,.55)}
    .candTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .candMeta{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .candTitle{font-weight:900; letter-spacing:.3px}
    .candReason{color:var(--muted); font-size:12px; margin-top:6px; line-height:1.35}
    pre{
      margin:0;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      padding:12px;
      border-radius:12px;
      overflow:auto;
      font-family:var(--mono);
      font-size:12px;
      line-height:1.4;
      max-height:340px;
    }
    .toast{
      position:fixed;
      right:18px;
      bottom:18px;
      max-width:520px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(17,26,51,.94);
      box-shadow:var(--shadow);
      display:none;
      gap:10px;
      align-items:flex-start;
      z-index:9999;
    }
    .toast.show{display:flex}
    .toast .tTitle{font-weight:900}
    .toast .tMsg{color:var(--muted); font-size:12px; margin-top:2px; line-height:1.35}
    .minihr{height:1px;background:rgba(34,50,91,.75); margin:10px 0}
    .checkrow{display:flex; gap:10px; align-items:center; margin-top:10px}
    .checkrow input{width:auto}
    .hold{
      border:1px dashed rgba(255,204,102,.65);
      background:rgba(255,204,102,.06);
      padding:10px 12px;
      border-radius:12px;
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }
    .split2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media(max-width:560px){ .split2{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>Guardian Futures Engine</h1>
        <div class="sub">
          Scan ‚Üí choose ‚Üí analyze. Scanning is always allowed. Trading stays protected.
          <span class="muted">(America/Chicago)</span>
        </div>
        <div class="pillrow" style="margin-top:6px">
          <div class="pill"><strong>Universe</strong>: <span id="universeLabel">Loading‚Ä¶</span></div>
          <div class="pill"><strong>Engine</strong>: <span id="engineLabel">‚Äî</span></div>
          <div class="pill"><strong>Mode</strong>: <span id="modeLabel">Real</span></div>
        </div>
      </div>

      <div class="pillrow">
        <div class="pill"><strong>Ready</strong>: UI + API</div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Scan + Controls -->
      <div class="card">
        <div class="hd">
          <h2>Scan Best Trades</h2>
          <span id="scanBadge" class="badge b-neutral"><span class="dot"></span><span>Idle</span></span>
        </div>
        <div class="bd">
          <div class="split2">
            <div>
              <div class="k">Equity (USD)</div>
              <input id="equity" type="number" min="10" step="10" value="200" />
            </div>
            <div>
              <div class="k">Test Mode</div>
              <select id="testMode">
                <option value="0" selected>Off (real mode)</option>
                <option value="1">On (force TRADE_AVAILABLE)</option>
              </select>
              <div class="small muted" style="margin-top:6px">Use only to verify UI.</div>
            </div>
          </div>

          <div class="btnrow">
            <button class="primary" id="btnScan">‚ö° Scan Best Trades</button>
            <button id="btnAnalyze" disabled>üîé Analyze Selected</button>
          </div>

          <div class="minihr"></div>

          <div class="k">Best Trades Right Now (Top 3)</div>
          <div class="small muted" id="scanMeta" style="margin-top:6px">Click a candidate to select it.</div>

          <div class="table" id="candList" style="margin-top:12px"></div>
        </div>
      </div>

      <!-- RIGHT: Trade Card -->
      <div class="card">
        <div class="hd">
          <h2>Trade Card</h2>
          <span id="stateBadge" class="badge b-neutral"><span class="dot"></span><span>‚Äî</span></span>
        </div>
        <div class="bd">
          <div class="row">
            <div class="k">Selected</div>
            <div class="v" id="selSymbol">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">Trend (15m)</div>
            <div class="v" id="trendDir">‚Äî</div>
          </div>
          <div class="row">
            <div class="k">Reason</div>
            <div class="v muted" id="reason" style="text-align:right; max-width:65%">Scan first, then analyze.</div>
          </div>

          <div id="levelsBox" style="display:none">
            <div class="minihr"></div>
            <div class="row"><div class="k">Levels</div><div class="v" id="levelsDir">‚Äî</div></div>
            <div class="row"><div class="k">Entry</div><div class="v mono" id="lvlEntry">‚Äî</div></div>
            <div class="row"><div class="k">Stop</div><div class="v mono" id="lvlStop">‚Äî</div></div>
            <div class="row"><div class="k">TP1 (30%)</div><div class="v mono" id="lvlTP1">‚Äî</div></div>
            <div class="row"><div class="k">TP2 (30%)</div><div class="v mono" id="lvlTP2">‚Äî</div></div>
            <div class="row"><div class="k">Runner (40%)</div><div class="v muted">Trail structure (manual)</div></div>
          </div>

          <div id="posBox" style="display:none">
            <div class="minihr"></div>
            <div class="row"><div class="k">Position (sizing)</div><div class="v">‚Äî</div></div>
            <div class="row"><div class="k">Risk (USD)</div><div class="v mono" id="posRisk">‚Äî</div></div>
            <div class="row"><div class="k">Notional (USD)</div><div class="v mono" id="posNotional">‚Äî</div></div>
            <div class="row"><div class="k">Qty (approx)</div><div class="v mono" id="posQty">‚Äî</div></div>
            <div class="row"><div class="k">Leverage hint</div><div class="v mono" id="posLev">‚Äî</div></div>
          </div>

          <div id="ordersBox" style="display:none">
            <div class="minihr"></div>
            <div class="row"><div class="k">Orders</div><div class="v">‚Äî</div></div>
            <div class="row"><div class="k">Entry</div><div class="v mono" id="ordEntry">‚Äî</div></div>
            <div class="row"><div class="k">Stop loss</div><div class="v mono" id="ordSL">‚Äî</div></div>
            <div class="row"><div class="k">TP1</div><div class="v mono" id="ordTP1">‚Äî</div></div>
            <div class="row"><div class="k">TP2</div><div class="v mono" id="ordTP2">‚Äî</div></div>

            <div class="btnrow" style="margin-top:12px">
              <button id="btnCopyLevels" class="warn" disabled>üìã Copy Levels</button>
              <button id="btnCopyOrders" class="warn" disabled>üìã Copy Orders</button>
              <button id="btnOneClick" class="good" disabled>‚úÖ One-Click Prep</button>
            </div>

            <div class="hold">
              <div style="font-weight:800; color:var(--text)">One-Click Prep = Speed + Safety</div>
              <div style="margin-top:6px">
                It <b>copies</b> your ticket + <b>opens</b> TradingView. You still confirm execution on your platform.
                This prevents fat-finger losses and keeps discipline.
              </div>
              <div class="checkrow">
                <input id="chkConfirm" type="checkbox" />
                <label for="chkConfirm">I checked symbol + direction and I‚Äôm ready to prep this trade.</label>
              </div>
              <button id="btnHold" class="good" style="margin-top:10px" disabled>‚è± Hold 1s to Prep</button>
              <div class="small muted" style="margin-top:6px">Hold-to-prep reduces accidental clicks.</div>
            </div>
          </div>

          <div class="minihr"></div>
          <div class="k">Raw JSON</div>
          <pre id="raw" class="mono">Waiting‚Ä¶</pre>
        </div>
      </div>
    </div>

    <div class="toast" id="toast">
      <div style="margin-top:2px">
        <div class="tTitle" id="toastTitle">Copied</div>
        <div class="tMsg" id="toastMsg">‚Äî</div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Small helpers ----------
    const $ = (id) => document.getElementById(id);
    const fmt = (n) => (n === null || n === undefined) ? "‚Äî" : (typeof n === "number" ? (Number.isInteger(n) ? String(n) : n.toFixed(4).replace(/0+$/,'').replace(/\.$/,'') ) : String(n));
    const nowTime = () => new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    function toast(title, msg){
      $("toastTitle").textContent = title;
      $("toastMsg").textContent = msg;
      $("toast").classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=> $("toast").classList.remove("show"), 3200);
    }
    function setBadge(el, type, text){
      el.className = "badge " + (type || "b-neutral");
      el.innerHTML = '<span class="dot"></span><span>'+text+'</span>';
    }
    function tvSymbol(sym){
      // TradingView uses exchange prefixes; BINANCE is a solid default for charting.
      // (Execution platform may differ; TV is for fast visual confirmation.)
      return "BINANCE:" + sym;
    }
    function tvUrl(sym){
      // Simple chart link; user can set timeframe/indicators inside TV.
      return "https://www.tradingview.com/chart/?symbol=" + encodeURIComponent(tvSymbol(sym));
    }

    // ---------- State ----------
    let universe = [];
    let candidates = [];
    let selected = null; // {symbol}
    let lastAnalysis = null; // JSON response

    // ---------- API ----------
    async function apiGet(path){
      const r = await fetch(path, { cache: "no-store" });
      if(!r.ok) throw new Error("HTTP " + r.status);
      return await r.json();
    }

    async function loadUniverse(){
      try{
        const u = await apiGet("/api/analyze?universe=1");
        universe = (u.top || []).map(x => x.symbol);
        $("universeLabel").textContent = "Top 50 loaded";
      }catch(e){
        universe = [];
        $("universeLabel").textContent = "Fallback (API failed)";
      }
    }

    function scoreFromState(state){
      // Rank states: TRADE_AVAILABLE > SETUP_WATCH > NO_TRADE > BLOCKED
      if(state === "TRADE_AVAILABLE") return 100;
      if(state === "SETUP_WATCH") return 70;
      if(state === "NO_TRADE") return 35;
      if(state === "BLOCKED") return 0;
      return 10;
    }

    function badgeForState(state){
      if(state === "TRADE_AVAILABLE") return ["b-good", "TRADE_AVAILABLE"];
      if(state === "SETUP_WATCH") return ["b-warn", "SETUP_WATCH"];
      if(state === "NO_TRADE") return ["b-neutral", "NO_TRADE"];
      if(state === "BLOCKED") return ["b-bad", "BLOCKED"];
      return ["b-neutral", state || "‚Äî"];
    }

    async function scanTop3(){
      setBadge($("scanBadge"), "b-neutral", "Scanning‚Ä¶");
      $("scanMeta").textContent = "Scanning universe‚Ä¶";
      $("candList").innerHTML = "";
      candidates = [];
      selected = null;
      $("selSymbol").textContent = "‚Äî";
      $("btnAnalyze").disabled = true;

      const eq = Number($("equity").value || 200);
      const test = $("testMode").value;

      // If universe fails, use a tiny fallback list so UI still works
      const pool = (universe && universe.length) ? universe.slice(0, 50) : ["BTCUSDT","ETHUSDT","SOLUSDT"];

      // Scan = analyze a chunk and take best 3 by score
      // Keep it light for Vercel: sample up to 15 symbols each click
      const sample = pool.slice(0, 15);

      const results = [];
      for (let i = 0; i < sample.length; i++){
        const sym = sample[i];
        const url = `/api/analyze?symbol=${encodeURIComponent(sym)}&equity=${encodeURIComponent(eq)}${test==="1" ? "&test=1" : ""}`;
        try{
          const j = await apiGet(url);
          results.push(j);
          $("engineLabel").textContent = j.engineVersion || "‚Äî";
          $("modeLabel").textContent = (test==="1") ? "Test" : "Real";
        }catch(e){
          results.push({
            symbol: sym,
            state: "NO_TRADE",
            trend: { tf: "15m", dir: "NONE" },
            reason: "Scan error",
            why: ["‚úñ Scan error: " + String(e.message || e)]
          });
        }
      }

      results.sort((a,b) => scoreFromState(b.state) - scoreFromState(a.state));
      candidates = results.slice(0, 3);

      renderCandidates();
      setBadge($("scanBadge"), "b-good", "Done");
      $("scanMeta").textContent = `Last scan: ${nowTime()} ‚Ä¢ Showing ${candidates.length}`;
    }

    function renderCandidates(){
      const list = $("candList");
      list.innerHTML = "";
      candidates.forEach((c, idx) => {
        const div = document.createElement("div");
        div.className = "cand" + (selected && selected.symbol === c.symbol ? " sel" : "");
        const [bType, bText] = badgeForState(c.state);
        const trend = (c.trend && c.trend.dir) ? c.trend.dir : "‚Äî";
        div.innerHTML = `
          <div class="candTop">
            <div class="candMeta">
              <div class="candTitle">#${idx} ‚Ä¢ ${c.symbol || "‚Äî"}</div>
              <span class="badge ${bType}"><span class="dot"></span><span>${bText}</span></span>
              <span class="pill"><strong>15m</strong>: ${trend}</span>
            </div>
            <div class="pill"><strong>Score</strong>: ${scoreFromState(c.state)}</div>
          </div>
          <div class="candReason">${(c.reason || "‚Äî")}</div>
        `;
        div.onclick = () => {
          selected = { symbol: c.symbol };
          $("selSymbol").textContent = c.symbol || "‚Äî";
          $("btnAnalyze").disabled = !selected?.symbol;
          [...document.querySelectorAll(".cand")].forEach(x => x.classList.remove("sel"));
          div.classList.add("sel");
          // show a preview in raw
          $("raw").textContent = JSON.stringify(c, null, 2);
          const [t, txt] = badgeForState(c.state);
          setBadge($("stateBadge"), t, txt);
          $("trendDir").textContent = trend;
          $("reason").textContent = c.reason || "‚Äî";
          // clear trade boxes until analyze
          hideTradeBoxes();
        };
        list.appendChild(div);
      });
    }

    function hideTradeBoxes(){
      $("levelsBox").style.display = "none";
      $("posBox").style.display = "none";
      $("ordersBox").style.display = "none";
      $("btnCopyLevels").disabled = true;
      $("btnCopyOrders").disabled = true;
      $("btnOneClick").disabled = true;
      $("chkConfirm").checked = false;
      $("btnHold").disabled = true;
    }

    async function analyzeSelected(){
      if(!selected?.symbol) return;
      const sym = selected.symbol;
      const eq = Number($("equity").value || 200);
      const test = $("testMode").value;

      setBadge($("stateBadge"), "b-neutral", "Analyzing‚Ä¶");
      $("reason").textContent = "Loading‚Ä¶";

      const url = `/api/analyze?symbol=${encodeURIComponent(sym)}&equity=${encodeURIComponent(eq)}${test==="1" ? "&test=1" : ""}`;
      const j = await apiGet(url);
      lastAnalysis = j;

      $("engineLabel").textContent = j.engineVersion || "‚Äî";
      $("modeLabel").textContent = (test==="1") ? "Test" : "Real";

      $("selSymbol").textContent = j.symbol || sym;
      $("trendDir").textContent = (j.trend && j.trend.dir) ? j.trend.dir : "‚Äî";
      $("reason").textContent = j.reason || "‚Äî";
      $("raw").textContent = JSON.stringify(j, null, 2);

      const [t, txt] = badgeForState(j.state);
      setBadge($("stateBadge"), t, txt);

      // Fill boxes if trade available
      hideTradeBoxes();

      if(j.levels){
        $("levelsBox").style.display = "block";
        $("levelsDir").textContent = j.levels.dir || "‚Äî";
        $("lvlEntry").textContent = fmt(j.levels.entry);
        $("lvlStop").textContent = fmt(j.levels.stop);
        $("lvlTP1").textContent = fmt(j.levels.tp1);
        $("lvlTP2").textContent = fmt(j.levels.tp2);
      }
      if(j.position){
        $("posBox").style.display = "block";
        $("posRisk").textContent = "$" + fmt(j.position.riskUSD);
        $("posNotional").textContent = "$" + fmt(j.position.notionalUSD);
        $("posQty").textContent = fmt(j.position.qtyApprox);
        $("posLev").textContent = j.position.leverageHint || "‚Äî";
      }
      if(j.orders){
        $("ordersBox").style.display = "block";
        $("ordEntry").textContent = `${j.orders.entrySide || "‚Äî"} ‚Ä¢ ${j.orders.entryType || "‚Äî"} @ ${fmt(j.orders.entryPrice)}`;
        $("ordSL").textContent = `${fmt(j.orders.stopLoss?.price)} (exit: ${j.orders.stopLoss?.side || "‚Äî"})`;
        const tp1 = j.orders.takeProfits?.[0];
        const tp2 = j.orders.takeProfits?.[1];
        $("ordTP1").textContent = tp1 ? `${fmt(tp1.price)} ‚Ä¢ ${Math.round((tp1.qtyPct||0)*100)}%` : "‚Äî";
        $("ordTP2").textContent = tp2 ? `${fmt(tp2.price)} ‚Ä¢ ${Math.round((tp2.qtyPct||0)*100)}%` : "‚Äî";
      }

      const canCopy = (j.state === "TRADE_AVAILABLE" && j.levels && j.orders);
      $("btnCopyLevels").disabled = !canCopy;
      $("btnCopyOrders").disabled = !canCopy;
      $("btnOneClick").disabled = !canCopy;
      $("btnHold").disabled = !(canCopy && $("chkConfirm").checked);
    }

    function levelsTicket(j){
      const L = j.levels || {};
      const P = j.position || {};
      const O = j.orders || {};
      const dir = (L.dir || "‚Äî");
      const sym = (j.symbol || "‚Äî");
      const eq = (j.risk?.equity ?? "‚Äî");

      // Broker-ready ‚Äúticket‚Äù (human-readable; fastest to paste into notes)
      const lines = [
        `GUARDIAN TICKET (${j.engineVersion || "‚Äî"})`,
        `Time: ${new Date(j.ts || Date.now()).toLocaleString()}`,
        `Symbol: ${sym}`,
        `Direction: ${dir}`,
        `Equity: $${eq}`,
        "",
        `ENTRY: ${fmt(L.entry)}   (${O.entryType || "MARKET_ON_TRIGGER"} | side ${O.entrySide || "‚Äî"})`,
        `STOP:  ${fmt(L.stop)}   (exit side ${O.stopLoss?.side || "‚Äî"})`,
        `TP1:   ${fmt(L.tp1)}   (30%)`,
        `TP2:   ${fmt(L.tp2)}   (30%)`,
        `RUNNER: 40%   (manual trail)`,
        "",
        `SIZE: qty ‚âà ${fmt(P.qtyApprox)}   notional ‚âà $${fmt(P.notionalUSD)}   risk ‚âà $${fmt(P.riskUSD)}`,
        `Leverage hint: ${P.leverageHint || "‚Äî"}`,
        "",
        `NOTES:`,
        `- Stage A = sweep intrabar (watch)`,
        `- Stage B = close confirm (trade allowed)`,
        `- Use reduce-only for TP/SL if supported`,
      ];
      return lines.join("\n");
    }

    async function copyText(text){
      await navigator.clipboard.writeText(text);
    }

    async function onCopyLevels(){
      if(!lastAnalysis?.levels) return;
      const L = lastAnalysis.levels;
      const txt = [
        `SYMBOL ${lastAnalysis.symbol}`,
        `DIR ${L.dir}`,
        `ENTRY ${fmt(L.entry)}`,
        `STOP ${fmt(L.stop)}`,
        `TP1 ${fmt(L.tp1)} (30%)`,
        `TP2 ${fmt(L.tp2)} (30%)`,
        `RUNNER (40%) TRAIL`,
      ].join("\n");
      await copyText(txt);
      toast("Copied Levels", "Levels copied to clipboard.");
    }

    async function onCopyOrders(){
      if(!lastAnalysis?.orders) return;
      const O = lastAnalysis.orders;
      const txt = JSON.stringify(O, null, 2);
      await copyText(txt);
      toast("Copied Orders", "Orders JSON copied to clipboard.");
    }

    async function oneClickPrep(){
      if(!lastAnalysis || lastAnalysis.state !== "TRADE_AVAILABLE") return;

      const ticket = levelsTicket(lastAnalysis);

      // 1) copy ticket
      await copyText(ticket);

      // 2) open TradingView chart
      const sym = lastAnalysis.symbol;
      window.open(tvUrl(sym), "_blank", "noopener,noreferrer");

      // 3) toast + leave raw visible
      toast("One-Click Prep Complete", "Ticket copied + TradingView opened. Now place the trade on your platform.");
    }

    // Hold-to-prep (1 second)
    function setupHoldButton(){
      let timer = null;
      let holding = false;

      $("btnHold").addEventListener("mousedown", () => {
        if($("btnHold").disabled) return;
        holding = true;
        $("btnHold").textContent = "‚è± Holding‚Ä¶";
        timer = setTimeout(async () => {
          if(holding){
            await oneClickPrep();
            $("btnHold").textContent = "‚úÖ Hold 1s to Prep";
          }
        }, 1000);
      });

      ["mouseup","mouseleave"].forEach(ev => {
        $("btnHold").addEventListener(ev, () => {
          holding = false;
          if(timer) clearTimeout(timer);
          $("btnHold").textContent = "‚è± Hold 1s to Prep";
        });
      });

      // Mobile
      $("btnHold").addEventListener("touchstart", (e) => {
        e.preventDefault();
        if($("btnHold").disabled) return;
        holding = true;
        $("btnHold").textContent = "‚è± Holding‚Ä¶";
        timer = setTimeout(async () => {
          if(holding){
            await oneClickPrep();
            $("btnHold").textContent = "‚úÖ Hold 1s to Prep";
          }
        }, 1000);
      }, {passive:false});
      $("btnHold").addEventListener("touchend", () => {
        holding = false;
        if(timer) clearTimeout(timer);
        $("btnHold").textContent = "‚è± Hold 1s to Prep";
      });
    }

    // ---------- Wire up ----------
    $("btnScan").onclick = scanTop3;
    $("btnAnalyze").onclick = analyzeSelected;

    $("btnCopyLevels").onclick = onCopyLevels;
    $("btnCopyOrders").onclick = onCopyOrders;
    $("btnOneClick").onclick = () => {
      toast("Use Hold-to-Prep", "Check the box and hold the button for 1 second.");
    };

    $("chkConfirm").addEventListener("change", () => {
      const can = lastAnalysis && lastAnalysis.state === "TRADE_AVAILABLE" && lastAnalysis.levels && lastAnalysis.orders;
      $("btnHold").disabled = !(can && $("chkConfirm").checked);
    });

    // initial
    (async function init(){
      setBadge($("scanBadge"), "b-neutral", "Idle");
      setBadge($("stateBadge"), "b-neutral", "‚Äî");
      await loadUniverse();
      $("engineLabel").textContent = "‚Äî";
      setupHoldButton();
      toast("Ready", "Click ‚ÄúScan Best Trades‚Äù to start.");
    })();
  </script>
</body>
</html>
